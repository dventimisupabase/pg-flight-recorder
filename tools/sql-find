#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   gg def <symbol>          # find definitions (tables, functions, views, columns)
#   gg grep <pattern>        # search file contents with grep
#   gg path <pattern>        # find file paths matching pattern
#   gg ctx <file>:<line>     # show context around a location

# Change to repo root
cd "$(git rev-parse --show-toplevel)"

INDEX_FILE="SQL_INDEX.json"
IMAGE="dventimisupabase/pglast-indexer:latest"

# Generate SQL_INDEX.json if missing
generate_index() {
    echo "SQL_INDEX.json not found. Generating..." >&2

    if command -v python3 &>/dev/null; then
        # Check if pglast is available locally
        if python3 -c "import pglast" 2>/dev/null; then
            echo "Using local pglast installation..." >&2
            ./tools/sql-index > "$INDEX_FILE"
            echo "Done. SQL_INDEX.json generated." >&2
            return 0
        fi
    fi

    # Fall back to Docker
    if command -v docker &>/dev/null; then
        echo "Using Docker ($IMAGE)..." >&2
        if ! docker image inspect "$IMAGE" &>/dev/null; then
            echo "Pulling $IMAGE..." >&2
            docker pull "$IMAGE" || {
                echo "Error: Could not pull Docker image" >&2
                echo "Build locally: docker build -t pglast-indexer -f tools/Dockerfile.pglast ." >&2
                exit 1
            }
        fi
        docker run --rm -v "$(pwd):/src" "$IMAGE" > "$INDEX_FILE"
        echo "Done. SQL_INDEX.json generated." >&2
        return 0
    fi

    echo "Error: Neither pglast nor Docker available." >&2
    echo "" >&2
    echo "Options:" >&2
    echo "  1. Install pglast: pip install pglast>=7.0" >&2
    echo "  2. Install Docker and try again" >&2
    echo "  3. Run: ./tools/setup-sql-index --docker" >&2
    exit 1
}

# Ensure index exists
if [[ ! -f "$INDEX_FILE" ]]; then
    generate_index
fi

cmd="${1:-}"; shift || true

case "$cmd" in
  def)
    pattern="$1"
    # Search for definitions in SQL_INDEX.json using jq
    if ! command -v jq &>/dev/null; then
        echo "Error: jq required for def command. Install with: brew install jq" >&2
        exit 1
    fi

    # Search tables, functions, views, types, and columns
    jq -r --arg pat "$pattern" '
      .[] |
      .file as $file |
      (
        # Tables
        (.tables[]? | select(.name | test($pat; "i")) | "\(.name)\t\(.line)\t\($file)\ttable"),
        # Table columns
        (.tables[]? | .name as $tbl | .columns[]? | select(.name | test($pat; "i")) | "\($tbl).\(.name)\t\(.line)\t\($file)\tcolumn (\(.type))"),
        # Functions
        (.functions[]? | select(.name | test($pat; "i")) | "\(.name)\t\(.line)\t\($file)\tfunction -> \(.returns)"),
        # Views
        (.views[]? | select(.name | test($pat; "i")) | "\(.name)\t\(.line)\t\($file)\tview"),
        # Types
        (.types[]? | select(.name | test($pat; "i")) | "\(.name)\t\(.line)\t\($file)\ttype (\(.kind))")
      )
    ' "$INDEX_FILE" | column -t -s$'\t' 2>/dev/null || cat
    ;;

  grep)
    # Fall back to grep for content search
    pattern="$1"
    grep -rn --include="*.sql" "$pattern" . 2>/dev/null || true
    ;;

  path)
    # Find files matching pattern
    pattern="$1"
    find . -name "*.sql" -type f 2>/dev/null | grep -E "$pattern" || true
    ;;

  ctx)
    loc="$1"
    file="${loc%:*}"
    line="${loc##*:}"
    start=$(( line>20 ? line-20 : 1 ))
    end=$(( line+20 ))
    nl -ba "$file" | sed -n "${start},${end}p"
    ;;

  stats)
    # Show index statistics
    if ! command -v jq &>/dev/null; then
        echo "Error: jq required. Install with: brew install jq" >&2
        exit 1
    fi
    jq -r '
      "Files indexed: \(length)",
      "Tables: \([.[].tables | length] | add // 0)",
      "Functions: \([.[].functions | length] | add // 0)",
      "Views: \([.[].views | length] | add // 0)",
      "Types: \([.[].types | length] | add // 0)",
      "Total columns: \([.[].tables[].columns | length] | add // 0)"
    ' "$INDEX_FILE"
    ;;

  regen|regenerate)
    # Force regeneration of index
    rm -f "$INDEX_FILE"
    generate_index
    ;;

  *)
    echo "Usage: gg {def|grep|path|ctx|stats|regen} ..." >&2
    echo "" >&2
    echo "Commands:" >&2
    echo "  def <symbol>     Find SQL object definitions (tables, functions, views, columns)" >&2
    echo "  grep <pattern>   Search file contents" >&2
    echo "  path <pattern>   Find file paths" >&2
    echo "  ctx <file>:<n>   Show context around line n" >&2
    echo "  stats            Show index statistics" >&2
    echo "  regen            Regenerate SQL_INDEX.json" >&2
    exit 2
    ;;
esac
